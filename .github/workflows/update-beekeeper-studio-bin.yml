# Check for new Beekeeper Studio release and open a PR to update PKGBUILD.
# Runs weekly (Monday 06:00 UTC) and can be triggered manually (Actions tab -> Run workflow).

name: Update beekeeper-studio-bin

on:
  workflow_dispatch:
  schedule:
    # Weekly on Monday at 06:00 UTC
    - cron: '0 6 * * 1'

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set skip Create PR flag
        id: skip_create_pr
        run: echo "skip=${{ secrets.SKIP_CREATE_PR }}" >> "$GITHUB_OUTPUT"

      - name: Get current and latest version
        id: versions
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || github.token }}
        run: |
          REPO="beekeeper-studio/beekeeper-studio"
          PKGBUILD="src/beekeeper-studio-bin/PKGBUILD"
          current=$(grep '^pkgver=' "$PKGBUILD" | cut -d= -f2)
          CURL_OPTS=()
          [[ -n "${GH_API_TOKEN:-}" ]] && CURL_OPTS=(-H "Authorization: Bearer $GH_API_TOKEN")
          resp=$(curl -sS "${CURL_OPTS[@]}" "https://api.github.com/repos/$REPO/releases/latest")
          latest=$(echo "$resp" | grep -o '"tag_name": *"[^"]*"' | head -n1 | sed 's/"tag_name": *"v\?\([^"]*\)"/\1/')
          if [[ -z "$latest" ]]; then
            echo "Could not parse latest release"
            exit 1
          fi
          older=$(printf '%s\n%s' "$current" "$latest" | sort -V | head -n1)
          update_available=false
          [[ "$older" == "$current" && "$current" != "$latest" ]] && update_available=true
          echo "current=$current" >> "$GITHUB_OUTPUT"
          echo "latest=$latest" >> "$GITHUB_OUTPUT"
          echo "update_available=$update_available" >> "$GITHUB_OUTPUT"
          echo "Current: $current | Latest: $latest | Update: $update_available"

      - name: Download packages and compute checksums
        if: steps.versions.outputs.update_available == 'true'
        id: checksums
        run: |
          latest="${{ steps.versions.outputs.latest }}"
          PKGDIR="src/beekeeper-studio-bin"

          # Download x86_64 and aarch64 .pacman releases
          curl -sSLo "${PKGDIR}/beekeeper-studio-x86_64.pacman" "https://github.com/beekeeper-studio/beekeeper-studio/releases/download/v${latest}/beekeeper-studio-${latest}.pacman"
          curl -sSLo "${PKGDIR}/beekeeper-studio-aarch64.pacman" "https://github.com/beekeeper-studio/beekeeper-studio/releases/download/v${latest}/beekeeper-studio-${latest}-aarch64.pacman"

          sha_x64=$(sha256sum -b "${PKGDIR}/beekeeper-studio-x86_64.pacman" | awk '{ print $1 }')
          sha_a64=$(sha256sum -b "${PKGDIR}/beekeeper-studio-aarch64.pacman" | awk '{ print $1 }')
          sha_license=$(sha256sum -b "${PKGDIR}/LICENSE-COMMERCIAL" | awk '{ print $1 }')

          echo "sha256_x86_64=$sha_x64" >> "$GITHUB_OUTPUT"
          echo "sha256_aarch64=$sha_a64" >> "$GITHUB_OUTPUT"
          echo "sha256_license=$sha_license" >> "$GITHUB_OUTPUT"

      - name: Clean downloaded assets
        if: steps.versions.outputs.update_available == 'true'
        run: |
          rm -f src/beekeeper-studio-bin/beekeeper-studio-x86_64.pacman src/beekeeper-studio-bin/beekeeper-studio-aarch64.pacman

      - name: Update PKGBUILD
        if: steps.versions.outputs.update_available == 'true'
        run: |
          PKGBUILD="src/beekeeper-studio-bin/PKGBUILD"
          latest="${{ steps.versions.outputs.latest }}"
          sha_license="${{ steps.checksums.outputs.sha256_license }}"
          sha_x64="${{ steps.checksums.outputs.sha256_x86_64 }}"
          sha_a64="${{ steps.checksums.outputs.sha256_aarch64 }}"

          sed -i "s/^pkgver=.*/pkgver=${latest}/" "$PKGBUILD"
          sed -i "s/^pkgrel=.*/pkgrel=1/" "$PKGBUILD"
          sed -i "s/^sha256sums=(.*/sha256sums=('${sha_license}')/" "$PKGBUILD"
          sed -i "s/^sha256sums_x86_64=(.*/sha256sums_x86_64=('${sha_x64}')/" "$PKGBUILD"
          sed -i "s/^sha256sums_aarch64=(.*/sha256sums_aarch64=('${sha_a64}')/" "$PKGBUILD"

          echo "Updated PKGBUILD:"
          grep -E '^(pkgver|pkgrel|sha256sums)' "$PKGBUILD"

      - name: Create Pull Request
        if: steps.versions.outputs.update_available == 'true' && steps.skip_create_pr.outputs.skip != 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GH_API_TOKEN }}
          branch: update/beekeeper-studio-bin-${{ steps.versions.outputs.latest }}
          title: "chore(beekeeper-studio-bin): bump to ${{ steps.versions.outputs.latest }}"
          body: |
            Automated update for **beekeeper-studio-bin**.
            - **Previous:** ${{ steps.versions.outputs.current }}
            - **New:** ${{ steps.versions.outputs.latest }}
            - `pkgrel` reset to 1; `sha256sums` updated (LICENSE-COMMERCIAL, x86_64, aarch64).
          add-paths: src/beekeeper-studio-bin/PKGBUILD
          commit-message: "chore(beekeeper-studio-bin): bump to ${{ steps.versions.outputs.latest }}"
